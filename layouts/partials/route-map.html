{{ $lang := .Site.Language.Lang }}

{{ $translations := dict
    "ru" (dict
        "unknown_station" "Неизвестная станция"
        "show_stations" "Показать названия станций"
        "expand_map" "Развернуть карту"
    )
    "en" (dict
        "unknown_station" "Unknown station"
        "show_stations" "Show station names"
        "expand_map" "Expand map"
    )
    "ka" (dict
        "unknown_station" "უცნობი სადგური"
        "show_stations" "სადგურთა სახელების ნახვა"
        "expand_map" "რუკის გაშლა"
    )
}}

{{ $t := index $translations $lang }}

<div class="route-map-container">
    <div id="route-map" data-route-ref="{{ .Params.ref }}" class="route-map-container">
        <!-- Transparent overlay to block interactivity -->
        <div class="map-overlay" id="map-overlay"></div>
        
        <!-- Expand button -->
        <button class="map-expand-button" id="expand-map-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m21 21-6-6m6 6v-4.8m0 4.8h-4.8"/>
                <path d="M3 16.2V21m0 0h4.8M3 21l6-6"/>
                <path d="M21 7.8V3m0 0h-4.8M21 3l-6 6"/>
                <path d="M3 7.8V3m0 0h4.8M3 3l6 6"/>
            </svg>
            {{ $t.expand_map }}
        </button>
    </div>
</div>

<script type="module">
    import SimpleRouteMap from '/js/components/map/SimpleRouteMap.js';
    
    const routeRef = document.getElementById('route-map').dataset.routeRef;
    const mapContainer = document.getElementById('route-map');
    const overlay = document.getElementById('map-overlay');
    const expandBtn = document.getElementById('expand-map-btn');
    
    let map = null;
    let isFullscreen = false;
    let originalParent = null;
    let originalNextSibling = null;
    let scrollX = 0;
    let scrollY = 0;
    let initialCenter = null;
    let initialZoom = null;
    
    // Create map
    function initializeMap() {
        map = new SimpleRouteMap('route-map', routeRef);
        map.initialize();
        
        // Save initial parameters after map load
        map.map.on('load', () => {
            // Small delay to let the map set its final position
            setTimeout(() => {
                initialCenter = map.map.getCenter();
                initialZoom = map.map.getZoom();
            }, 500);
        });
    }
    
    // Enter fullscreen mode
    function enterFullscreen() {
        if (isFullscreen) return;
        
        // Save current scroll position FIRST
        scrollX = window.pageXOffset || document.documentElement.scrollLeft;
        scrollY = window.pageYOffset || document.documentElement.scrollTop;
        
        // Remember original position
        originalParent = mapContainer.parentNode;
        originalNextSibling = mapContainer.nextSibling;
        
        // Create fullscreen container
        const fullscreenContainer = document.createElement('div');
        fullscreenContainer.id = 'fullscreen-container';
        fullscreenContainer.className = 'fullscreen-container';
        
        // Create close button
        const closeBtn = document.createElement('button');
        closeBtn.className = 'fullscreen-close-button';
        closeBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18"/>
                <path d="M6 6l12 12"/>
            </svg>
        `;
        closeBtn.onclick = exitFullscreen;
        
        // Update map styles for fullscreen mode
        mapContainer.className = 'fullscreen-map-container';
        
        // Hide overlay and expand button
        overlay.style.display = 'none';
        expandBtn.style.display = 'none';
        
        // Add elements to fullscreen container
        fullscreenContainer.appendChild(closeBtn);
        fullscreenContainer.appendChild(mapContainer);
        document.body.appendChild(fullscreenContainer);
        
        // Block page scrolling
        document.body.style.top = `-${scrollY}px`;
        document.body.style.left = `-${scrollX}px`;
        document.body.classList.add('fullscreen-open');
        document.documentElement.classList.add('fullscreen-open');
        
        // Update map size
        setTimeout(() => {
            if (map && map.map) {
                map.map.resize();
            }
        }, 100);
        
        isFullscreen = true;
        
        // Close on ESC
        document.addEventListener('keydown', handleEscape);
    }
    
    // Exit fullscreen mode
    function exitFullscreen() {
        if (!isFullscreen) return;
        
        const fullscreenContainer = document.getElementById('fullscreen-container');
        
        // Return map to its place
        mapContainer.className = 'route-map-container';
        
        // Show overlay and expand button
        overlay.style.display = 'block';
        expandBtn.style.display = 'flex';
        
        // Return map to original location
        if (originalNextSibling) {
            originalParent.insertBefore(mapContainer, originalNextSibling);
        } else {
            originalParent.appendChild(mapContainer);
        }
        
        // Remove fullscreen container
        if (fullscreenContainer) {
            fullscreenContainer.remove();
        }
        
        // Unblock page scrolling and restore position
        document.body.classList.remove('fullscreen-open');
        document.documentElement.classList.remove('fullscreen-open');
        document.body.style.top = '';
        document.body.style.left = '';
        
        // Restore scroll position
        setTimeout(() => {
            window.scrollTo(scrollX, scrollY);
        }, 0);
        
        // Update map size and reset state
        setTimeout(() => {
            if (map && map.map) {
                map.map.resize();
                
                // Reset map to initial state
                if (initialCenter && initialZoom !== null) {
                    map.map.setCenter(initialCenter);
                    map.map.setZoom(initialZoom);
                }
            }
        }, 150);
        
        isFullscreen = false;
        document.removeEventListener('keydown', handleEscape);
    }
    
    function handleEscape(e) {
        if (e.key === 'Escape') {
            exitFullscreen();
        }
    }
    
    // Event handlers
    expandBtn.addEventListener('click', enterFullscreen);
    
    // Initialize map
    initializeMap();
</script>